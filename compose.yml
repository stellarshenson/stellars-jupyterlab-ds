# --------------------------------------------------------------------------------------------------
#
#   Stellars Jupyterlab DS Platform 
#   Project Home: https://github.com/stellarshenson/stellars-jupyterlab-ds
#   This compose file support both GPU and non-GPU platforms
#
#   Jupyter Lab      - https://localhost/<compose_name>/jupyterlab (running locally on port :8888)
#   Tensorboard      - https://localhost/<compose_name>/tensorboard (running locally on port :6006)
#   MLFlow           - https://localhost/<compose_name>/mlflow (running locally on port :5000) 
#   Glances          - https://localhost/<compose_name>/glances (running locally on port :61208)
#   Optuna           - https://localhost/<compose_name>/optuna (running locally on port :8080)
#   Generic app      - https://localhost/<compose_name>/generic-app (running locally on port :8080)
#   Generic callback - https://localhost/<compose_name>/generic-app (running locally on port :8030)
#
#   Example project .env file content:
#   COMPOSE_PROJECT_NAME=my-lab-platform
#   LAB_USER=jack_daniels
#   JUPYTERLAB_SERVER_TOKEN=my_secret_token123
#   GPU_SUPPORT_ENABLED=1
#
# --------------------------------------------------------------------------------------------------

services:

  # Proxy for smart trafic routing to make it possible
  # to host multiple similar containers 
  traefik:
    image: traefik:latest
    container_name: ${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-traefik
    command:
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--api.dashboard=true"
      - "--api.insecure=true"  
      - "--providers.file.filename=/mnt/certs/certs.yml" # certificates generated by jupyterlab container
      - "--serverstransport.insecureskipverify=true" # required for https passthrough
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - vol_certs:/mnt/certs # named volume to hold certificates
    networks:
      - proxy-network
    depends_on:
      jupyterlab:
        condition: service_healthy
    restart: unless-stopped


  ## Run jupyterlab via traefic with glances, mlflow, optuna and tensorboard
  ## Services are mapped to distinct URLs using traefic proxy
  jupyterlab:
    container_name: ${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab
    hostname: ${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab
    image: stellars/stellars-jupyterlab-ds:latest
    build:
      context: build
      dockerfile: Dockerfile
    environment:
      - CONDA_DEFAULT_ENV=base
      - GPU_SUPPORT_ENABLED=0
      - JUPYTERLAB_SERVER_IP=*
      - JUPYTERLAB_SERVER_TOKEN=${JUPYTERLAB_SERVER_TOKEN:-} # if token not provided - no passwor required
      - JUPYTERLAB_BASE_URL=/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/jupyterlab
      - TF_CPP_MIN_LOG_LEVEL=3 # tensorflow logs ERR only
      - TENSORBOARD_LOGDIR=/tmp/tensorboard
      - MLFLOW_TRACKING_URI=http://localhost:5000
      - MLFLOW_PORT=5000
      - MLFLOW_HOST=*
      - LAB_USER=${LAB_USER:-default}
      - LAB_NAME=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}
    volumes:
      - vol_home:/home                    # jupyterlab user directory persistence
      - vol_workspace:/home/lab/workspace # user projects workspace volume persistence
      - vol_cache:/mnt/cache              # persistent cache volume for calculation results
      - vol_certs:/mnt/certs              # tsl certificates used by traefic and jupyterlab
      - vol_mlflow:/mnt/mlflow            # persistent mlflow volume for experiments logs
    networks:
      - proxy-network
    labels:
      # Enable proxy support from Traefik
      - "traefik.enable=true"

      # ⚙ JupyterLab Service (8888)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab-rtr.rule=Path(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/jupyterlab`) || PathPrefix(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/jupyterlab/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab-rtr.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab-rtr.service=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab-svc"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab-rtr.tls=true"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab-svc.loadbalancer.server.scheme=http"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-jupyterlab-svc.loadbalancer.server.port=8888"

      # ⚙ MLflow Service (5000)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-rtr.rule=Path(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/mlflow`) || PathPrefix(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/mlflow/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-rtr.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-rtr.tls=true"        
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-stripprefix.stripprefix.prefixes=/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/mlflow"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-redirectregex.redirectregex.regex=^(http[s]?://[^/]+)/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/mlflow$$"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-redirectregex.redirectregex.replacement=$${1}/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/mlflow/"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-chain.chain.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-redirectregex,${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-stripprefix"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-rtr.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-chain"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-rtr.service=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-svc"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-mlflow-svc.loadbalancer.server.port=5000"

      # ⚙ Glances Service (61208)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-rtr.rule=Path(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/glances`) || PathPrefix(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/glances/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-rtr.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-rtr.tls=true"        
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-stripprefix.stripprefix.prefixes=/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/glances"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-redirectregex.redirectregex.regex=^(http[s]?://[^/]+)/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/glances$$"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-redirectregex.redirectregex.replacement=$${1}/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/glances/"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-chain.chain.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-redirectregex,${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-stripprefix"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-rtr.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-chain"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-rtr.service=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-svc"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-glances-svc.loadbalancer.server.port=61208"

      # ⚙ TensorBoard Service (6006)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-rtr.rule=Path(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/tensorboard`) || PathPrefix(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/tensorboard/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-rtr.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-rtr.tls=true"        
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-stripprefix.stripprefix.prefixes=/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/tensorboard"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-redirectregex.redirectregex.regex=^(http[s]?://[^/]+)/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/tensorboard$$"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-redirectregex.redirectregex.replacement=$${1}/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/tensorboard/"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-chain.chain.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-redirectregex,${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-stripprefix"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-rtr.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-chain"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-rtr.service=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-svc"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-tensorboard-svc.loadbalancer.server.port=6006"

      # ⚙ Optuna Service (8080)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-rtr.rule=Path(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/optuna`) || PathPrefix(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/optuna/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-rtr.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-rtr.tls=true"        
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-stripprefix.stripprefix.prefixes=/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/optuna"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-redirectregex.redirectregex.regex=^(http[s]?://[^/]+)/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/optuna$$"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-redirectregex.redirectregex.replacement=$${1}/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/optuna/"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-chain.chain.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-redirectregex,${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-stripprefix"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-rtr.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-chain"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-rtr.service=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-svc"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-optuna-svc.loadbalancer.server.port=8080"

      # ⚙ Generic HTTP App Service (8080)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-rtr.rule=Path(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-app`) || PathPrefix(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-app/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-rtr.entrypoints=web"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-stripprefix.stripprefix.prefixes=/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-app"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-redirectregex.redirectregex.regex=^(http[s]?://[^/]+)/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-app$$"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-redirectregex.redirectregex.replacement=$${1}/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-app/"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-chain.chain.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-redirectregex,${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-stripprefix"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-rtr.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-chain"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-rtr.service=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-svc"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-app-svc.loadbalancer.server.port=8080"

      # ⚙  HTTP Generic HTTP Callback Service (8030)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-rtr.rule=Path(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-callback`) || PathPrefix(`/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-callback/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-rtr.entrypoints=web"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-stripprefix.stripprefix.prefixes=/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-callback"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-redirectregex.redirectregex.regex=^(http[s]?://[^/]+)/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-callback$$"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-redirectregex.redirectregex.replacement=$${1}/${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}/generic-callback/"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-chain.chain.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-redirectregex,${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-stripprefix"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-rtr.middlewares.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-chain"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-rtr.service=${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-svc"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-generic-callback-svc.loadbalancer.server.port=8030"
    ipc: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f jupyter-lab > /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s

  # for automatic environment refresh
  watchtower:
    container_name: ${COMPOSE_PROJECT_NAME:-stellars-jupyterlab-ds}-watchtower
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600
    security_opt:
      - seccomp:unconfined #optional
    depends_on:
      jupyterlab:
        condition: service_healthy 
      traefik:
        condition: service_started
    restart: unless-stopped
    privileged: true

volumes:
  vol_workspace:
  vol_cache:
  vol_home:
  vol_mlflow:
  vol_certs: 

networks:
  proxy-network:
    name: traefik-network
    driver: bridge

# EOF

