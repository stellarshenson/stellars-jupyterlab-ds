#!/bin/bash
# Enhanced bash completion for uv - the fast Python package manager
#
# Features:
#   - Full uv command completion (generated from uv itself)
#   - `uv run` completes executables from .venv/bin
#   - `uv tool run` / `uvx` completes installed tools
#   - `uv add` / `uv remove` completes installed packages
#   - Works with all uv flags and options
#
# Installation:
#   sudo cp uv /etc/bash_completion.d/uv
#   sudo chmod 644 /etc/bash_completion.d/uv
#
# Or for user-only:
#   mkdir -p ~/.local/share/bash-completion/completions
#   cp uv ~/.local/share/bash-completion/completions/uv

# -----------------------------------------------------------------------------
# Helper functions
# -----------------------------------------------------------------------------

# Find .venv directory by walking up the directory tree
_uv_find_venv() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.venv/bin" ]]; then
            echo "$dir/.venv/bin"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

# Get executable commands from .venv/bin
_uv_venv_commands() {
    local venv_bin
    venv_bin=$(_uv_find_venv) || return

    local cmd
    for cmd in "$venv_bin"/*; do
        if [[ -x "$cmd" && -f "$cmd" ]]; then
            basename "$cmd"
        fi
    done
}

# Get installed tool names from uv tool list
_uv_installed_tools() {
    uv tool list 2>/dev/null | grep -E '^\S' | awk '{print $1}' | sed 's/^-\+//'
}

# Get installed packages from pyproject.toml dependencies
_uv_installed_packages() {
    local pyproject
    local dir="$PWD"

    # Find pyproject.toml
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/pyproject.toml" ]]; then
            pyproject="$dir/pyproject.toml"
            break
        fi
        dir="$(dirname "$dir")"
    done

    [[ -z "$pyproject" ]] && return

    # Extract package names from dependencies section
    # Handles formats: "package", "package>=1.0", "package[extra]"
    sed -n '/^\[project\]/,/^\[/p' "$pyproject" 2>/dev/null | \
        sed -n '/^dependencies/,/^\]/p' | \
        grep -E '^\s*"' | \
        sed -E 's/.*"([a-zA-Z0-9_-]+).*/\1/'
}

# List of flags that take arguments (for skipping in command position detection)
_uv_run_flags_with_args() {
    echo "--extra --no-extra --group --no-group --only-group --env-file \
          --with --with-editable --with-requirements --index \
          --default-index --index-url --extra-index-url --find-links \
          --upgrade-package --reinstall-package --index-strategy \
          --keyring-provider --resolution --prerelease --fork-strategy \
          --config-setting --config-settings-package \
          --no-build-isolation-package --exclude-newer --exclude-newer-package \
          --link-mode --no-build-package --no-binary-package --refresh-package \
          --package --python --max-recursion-depth --python-platform \
          --cache-dir --python-preference --python-fetch --color \
          --allow-insecure-host --preview-features --directory --project \
          --config-file"
}

# Check if a flag takes an argument
_uv_flag_takes_arg() {
    local flag="$1"
    case "$flag" in
        --extra|--no-extra|--group|--no-group|--only-group|--env-file|\
        --with|-w|--with-editable|--with-requirements|--index|\
        --default-index|--index-url|-i|--extra-index-url|--find-links|-f|\
        --upgrade-package|-P|--reinstall-package|--index-strategy|\
        --keyring-provider|--resolution|--prerelease|--fork-strategy|\
        --config-setting|-C|--config-settings-package|\
        --no-build-isolation-package|--exclude-newer|--exclude-newer-package|\
        --link-mode|--no-build-package|--no-binary-package|--refresh-package|\
        --package|--python|-p|--max-recursion-depth|--python-platform|\
        --cache-dir|--python-preference|--python-fetch|--color|\
        --allow-insecure-host|--preview-features|--directory|--project|\
        --config-file)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

# Find the position of a subcommand in COMP_WORDS
_uv_find_subcommand() {
    local subcommand="$1"
    local i
    for ((i=1; i < COMP_CWORD; i++)); do
        if [[ "${COMP_WORDS[i]}" == "$subcommand" ]]; then
            echo "$i"
            return 0
        fi
    done
    return 1
}

# Find command position after subcommand and flags
_uv_find_cmd_position() {
    local start_pos="$1"
    local cmd_pos=$((start_pos + 1))

    while [[ $cmd_pos -lt $COMP_CWORD ]]; do
        local word="${COMP_WORDS[cmd_pos]}"
        case "$word" in
            -*)
                if _uv_flag_takes_arg "$word"; then
                    ((cmd_pos += 2))
                else
                    ((cmd_pos++))
                fi
                ;;
            *)
                break
                ;;
        esac
    done

    echo "$cmd_pos"
}

# -----------------------------------------------------------------------------
# Main completion function
# -----------------------------------------------------------------------------

_uv_enhanced() {
    local cur prev
    COMPREPLY=()

    if [[ "${BASH_VERSINFO[0]}" -ge 4 ]]; then
        cur="$2"
    else
        cur="${COMP_WORDS[COMP_CWORD]}"
    fi
    prev="$3"

    # Detect which subcommand we're in
    local run_index tool_run_index add_index remove_index
    run_index=$(_uv_find_subcommand "run")
    add_index=$(_uv_find_subcommand "add")
    remove_index=$(_uv_find_subcommand "remove")

    # Check for `uv tool run` specifically
    local in_tool_run=false
    local tool_index=$(_uv_find_subcommand "tool")
    if [[ -n "$tool_index" ]]; then
        local next_word="${COMP_WORDS[$((tool_index + 1))]}"
        if [[ "$next_word" == "run" ]]; then
            in_tool_run=true
            tool_run_index=$((tool_index + 1))
        fi
    fi

    # Handle `uv run` completion
    if [[ -n "$run_index" && -z "$tool_index" ]]; then
        local cmd_pos
        cmd_pos=$(_uv_find_cmd_position "$run_index")

        # Complete command position with venv executables
        if [[ $COMP_CWORD -eq $cmd_pos && "${cur}" != -* ]]; then
            local venv_cmds
            venv_cmds=$(_uv_venv_commands 2>/dev/null)
            COMPREPLY=( $(compgen -W "$venv_cmds" -- "${cur}") )
            COMPREPLY+=( $(compgen -f -- "${cur}") )
            return 0
        fi

        # After command, complete with files
        if [[ $COMP_CWORD -gt $cmd_pos ]]; then
            COMPREPLY=( $(compgen -f -- "${cur}") )
            return 0
        fi
    fi

    # Handle `uv tool run` completion
    if $in_tool_run; then
        local cmd_pos
        cmd_pos=$(_uv_find_cmd_position "$tool_run_index")

        if [[ $COMP_CWORD -eq $cmd_pos && "${cur}" != -* ]]; then
            local tools
            tools=$(_uv_installed_tools 2>/dev/null)
            COMPREPLY=( $(compgen -W "$tools" -- "${cur}") )
            return 0
        fi

        if [[ $COMP_CWORD -gt $cmd_pos ]]; then
            COMPREPLY=( $(compgen -f -- "${cur}") )
            return 0
        fi
    fi

    # Handle `uv remove` completion - complete with installed packages
    if [[ -n "$remove_index" ]]; then
        local cmd_pos
        cmd_pos=$(_uv_find_cmd_position "$remove_index")

        if [[ $COMP_CWORD -ge $cmd_pos && "${cur}" != -* ]]; then
            local packages
            packages=$(_uv_installed_packages 2>/dev/null)
            COMPREPLY=( $(compgen -W "$packages" -- "${cur}") )
            return 0
        fi
    fi

    # Fall back to default uv completion
    if type _uv &>/dev/null; then
        _uv "$@"
    else
        # Minimal fallback
        local subcommands="auth run init add remove version sync lock export tree format tool python pip venv build publish cache self help"
        if [[ $COMP_CWORD -eq 1 ]]; then
            COMPREPLY=( $(compgen -W "$subcommands" -- "${cur}") )
        fi
    fi
}

# -----------------------------------------------------------------------------
# Completion for uvx (alias for uv tool run)
# -----------------------------------------------------------------------------

_uvx_completion() {
    local cur prev
    COMPREPLY=()

    if [[ "${BASH_VERSINFO[0]}" -ge 4 ]]; then
        cur="$2"
    else
        cur="${COMP_WORDS[COMP_CWORD]}"
    fi

    # First argument: complete with installed tools
    if [[ $COMP_CWORD -eq 1 && "${cur}" != -* ]]; then
        local tools
        tools=$(_uv_installed_tools 2>/dev/null)
        COMPREPLY=( $(compgen -W "$tools" -- "${cur}") )
        return 0
    fi

    # After tool name: file completion
    if [[ $COMP_CWORD -gt 1 ]]; then
        COMPREPLY=( $(compgen -f -- "${cur}") )
        return 0
    fi
}

# -----------------------------------------------------------------------------
# Initialize completions
# -----------------------------------------------------------------------------

# Load the default uv completion first
if command -v uv &>/dev/null; then
    eval "$(uv generate-shell-completion bash 2>/dev/null)"
fi

# Override with enhanced completion
complete -F _uv_enhanced -o default -o bashdefault uv

# Add uvx completion if uvx exists
if command -v uvx &>/dev/null; then
    complete -F _uvx_completion -o default -o bashdefault uvx
fi
