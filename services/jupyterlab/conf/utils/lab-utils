#!/bin/bash
## Lab utilities - run platform utilities and scripts
# Lab Utils Script Runner with CLI support

set -e

GLOBAL_SCRIPTS_DIR="/opt/utils/lab-utils.d"
LOCAL_SCRIPTS_DIR="${HOME}/.local/lab-utils.d"

# Colors
BLUE='\033[1;34m'
CYAN='\033[0;36m'
GRAY='\033[0;00m'
NC='\033[0m' # No Color

# Function to extract description from script
get_script_description() {
    local script_file="$1"
    local description=""

    # Look for line starting with ## and extract description
    description=$(grep "^##" "$script_file" 2>/dev/null | head -1 | sed 's/^##[[:space:]]*//' || echo "")

    if [[ -z "$description" ]]; then
        description="No description available"
    fi

    echo "$description"
}

# Function to get executable scripts from a directory (top-level only)
# Returns: script_name|description|source_dir
get_scripts_from_dir() {
    local dir="$1"
    local source_label="$2"

    if [[ ! -d "$dir" ]]; then
        return
    fi

    for script in "$dir"/*.sh; do
        if [[ -f "$script" && -x "$script" ]]; then
            local basename_script=$(basename "$script")
            local name_without_ext="${basename_script%.sh}"
            local description=$(get_script_description "$script")
            echo "${name_without_ext}|${description}|${source_label}"
        fi
    done
}

# Function to get child scripts from a .d subdirectory
# Returns: parent/child|description|source_dir
get_child_scripts() {
    local parent_name="$1"
    local subdir="$2"
    local source_label="$3"

    if [[ ! -d "$subdir" ]]; then
        return
    fi

    for script in "$subdir"/*.sh; do
        if [[ -f "$script" && -x "$script" ]]; then
            local basename_script=$(basename "$script")
            local name_without_ext="${basename_script%.sh}"
            local description=$(get_script_description "$script")
            echo "${parent_name}/${name_without_ext}|${description}|${source_label}"
        fi
    done
}

# Function to get all scripts including nested ones from a directory
# Returns: script_name|description|source_dir (with parent/child format for nested)
get_all_scripts_from_dir() {
    local dir="$1"
    local source_label="$2"

    if [[ ! -d "$dir" ]]; then
        return
    fi

    for script in "$dir"/*.sh; do
        if [[ -f "$script" && -x "$script" ]]; then
            local basename_script=$(basename "$script")
            local name_without_ext="${basename_script%.sh}"
            local description=$(get_script_description "$script")
            echo "${name_without_ext}|${description}|${source_label}|top"

            # Check for corresponding .d subdirectory
            local subdir="${dir}/${name_without_ext}.d"
            if [[ -d "$subdir" ]]; then
                for child_script in "$subdir"/*.sh; do
                    if [[ -f "$child_script" && -x "$child_script" ]]; then
                        local child_basename=$(basename "$child_script")
                        local child_name="${child_basename%.sh}"
                        local child_description=$(get_script_description "$child_script")
                        echo "${name_without_ext}/${child_name}|${child_description}|${source_label}|child"
                    fi
                done
            fi
        fi
    done
}

# Function to get all scripts (global and local) - top level only
get_all_scripts() {
    get_scripts_from_dir "$GLOBAL_SCRIPTS_DIR" "global"
    get_scripts_from_dir "$LOCAL_SCRIPTS_DIR" "local:${LOCAL_SCRIPTS_DIR}"
}

# Function to get all scripts including nested (global and local)
get_all_scripts_hierarchical() {
    get_all_scripts_from_dir "$GLOBAL_SCRIPTS_DIR" "global"
    get_all_scripts_from_dir "$LOCAL_SCRIPTS_DIR" "local:${LOCAL_SCRIPTS_DIR}"
}

# Function to find script path by name (supports parent/child format)
find_script() {
    local name="$1"

    # Check if it's a nested path (contains /)
    if [[ "$name" == */* ]]; then
        local parent="${name%%/*}"
        local child="${name#*/}"

        # Check global first
        if [[ -x "${GLOBAL_SCRIPTS_DIR}/${parent}.d/${child}.sh" ]]; then
            echo "${GLOBAL_SCRIPTS_DIR}/${parent}.d/${child}.sh"
            return 0
        fi

        # Check local
        if [[ -x "${LOCAL_SCRIPTS_DIR}/${parent}.d/${child}.sh" ]]; then
            echo "${LOCAL_SCRIPTS_DIR}/${parent}.d/${child}.sh"
            return 0
        fi
    else
        # Top-level script
        # Check global first
        if [[ -x "${GLOBAL_SCRIPTS_DIR}/${name}.sh" ]]; then
            echo "${GLOBAL_SCRIPTS_DIR}/${name}.sh"
            return 0
        fi

        # Check local
        if [[ -x "${LOCAL_SCRIPTS_DIR}/${name}.sh" ]]; then
            echo "${LOCAL_SCRIPTS_DIR}/${name}.sh"
            return 0
        fi
    fi

    return 1
}

# Function to show help
show_help() {
    echo "Usage: lab-utils [OPTIONS] [SCRIPT_NAME]"
    echo ""
    echo "Lab utilities runner - execute platform utilities and scripts"
    echo ""
    echo "Options:"
    echo "  --help, -h         Show this help message"
    echo "  --list, -l         List available scripts with descriptions"
    echo "  --create-local     Create local scripts directory with demo script"
    echo ""
    echo "Arguments:"
    echo "  SCRIPT_NAME        Execute the specified script directly"
    echo "                     Use parent/child format for nested scripts"
    echo ""
    echo "When called without arguments, shows an interactive menu."
    echo ""
    echo "Script locations:"
    echo "  Global: ${GLOBAL_SCRIPTS_DIR}"
    echo "  Local:  ${LOCAL_SCRIPTS_DIR}"
    echo ""
    echo "Examples:"
    echo "  lab-utils                              # Show interactive menu"
    echo "  lab-utils --list                       # List all available scripts"
    echo "  lab-utils --create-local               # Scaffold local scripts"
    echo "  lab-utils test-cuda                    # Run top-level script"
    echo "  lab-utils git-utils/git-pull-repos    # Run nested script directly"
}

# Function to create local scripts directory with demo script
create_local_scripts() {
    if [[ -d "$LOCAL_SCRIPTS_DIR" ]]; then
        echo -e "${CYAN}Local scripts directory already exists:${NC} ${LOCAL_SCRIPTS_DIR}"
        echo ""
        echo "Use 'lab-utils --list' to see available scripts."
        return 0
    fi

    echo -e "${CYAN}Creating local scripts directory...${NC}"
    mkdir -p "$LOCAL_SCRIPTS_DIR"

    # Create demo script
    local demo_script="${LOCAL_SCRIPTS_DIR}/my-script.sh"
    cat > "$demo_script" << 'DEMO_EOF'
#!/bin/bash
## My custom script - template for local utilities

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${GREEN}Hello from your local script!${NC}"
echo ""
echo -e "${BLUE}This is a template script in your local lab-utils directory.${NC}"
echo "Edit this file or create new .sh scripts in:"
echo "  ${HOME}/.local/lab-utils.d/"
echo ""
echo "Tips:"
echo "  - Add '## Description' as the second line for --list display"
echo "  - Make scripts executable: chmod +x script.sh"
echo "  - Create parent.d/ subdirectories for nested scripts"
echo ""
echo "Arguments received: $@"
DEMO_EOF

    chmod +x "$demo_script"

    echo -e "${GREEN}Created local scripts directory:${NC} ${LOCAL_SCRIPTS_DIR}"
    echo -e "${GREEN}Created demo script:${NC} ${demo_script}"
    echo ""
    echo "Next steps:"
    echo "  1. Edit ${demo_script} for your needs"
    echo "  2. Create additional .sh scripts in ${LOCAL_SCRIPTS_DIR}"
    echo "  3. Run 'lab-utils --list' to see your scripts"
}

# Function to list scripts (hierarchical with indentation)
list_scripts() {
    local global_scripts=()
    local local_scripts=()

    # Collect scripts with hierarchy info
    while IFS='|' read -r name description source level; do
        if [[ "$source" == "global" ]]; then
            global_scripts+=("${name}|${description}|${level}")
        else
            local_scripts+=("${name}|${description}|${source}|${level}")
        fi
    done < <(get_all_scripts_hierarchical)

    # Print global scripts
    if [[ ${#global_scripts[@]} -gt 0 ]]; then
        echo -e "${CYAN}Global scripts${NC} ${GRAY}(${GLOBAL_SCRIPTS_DIR})${NC}"
        echo ""
        for entry in "${global_scripts[@]}"; do
            IFS='|' read -r name description level <<< "$entry"
            if [[ "$level" == "child" ]]; then
                # Indented child script
                printf "    ${GRAY}└─${NC} ${BLUE}%-23s${NC} %s\n" "$name" "$description"
            else
                # Top-level script
                printf "  ${BLUE}%-25s${NC} %s\n" "$name" "$description"
            fi
        done
        echo ""
    fi

    # Print local scripts
    if [[ ${#local_scripts[@]} -gt 0 ]]; then
        echo -e "${CYAN}Local scripts${NC} ${GRAY}(${LOCAL_SCRIPTS_DIR})${NC}"
        echo ""
        for entry in "${local_scripts[@]}"; do
            IFS='|' read -r name description source level <<< "$entry"
            if [[ "$level" == "child" ]]; then
                # Indented child script
                printf "    ${GRAY}└─${NC} ${BLUE}%-23s${NC} %s\n" "$name" "$description"
            else
                # Top-level script
                printf "  ${BLUE}%-25s${NC} %s\n" "$name" "$description"
            fi
        done
        echo ""
    elif [[ ! -d "$LOCAL_SCRIPTS_DIR" ]]; then
        echo -e "${GRAY}No local scripts directory. Create ${LOCAL_SCRIPTS_DIR} to add custom scripts.${NC}"
        echo ""
    fi
}

# Function to run interactive menu
run_interactive_menu() {
    # Check if dialog is available
    if ! command -v dialog &> /dev/null; then
        echo "Error: dialog command not found. Install it with:"
        echo "  Ubuntu/Debian: sudo apt install dialog"
        echo "  CentOS/RHEL: sudo yum install dialog"
        exit 1
    fi

    # Get available scripts
    mapfile -t SCRIPT_DATA < <(get_all_scripts)

    if [[ ${#SCRIPT_DATA[@]} -eq 0 ]]; then
        dialog --title "Error" --msgbox "No executable .sh scripts found" 10 50
        clear
        echo "No scripts available for execution."
        exit 1
    fi

    # Build menu options for dialog
    MENU_OPTIONS=()

    for entry in "${SCRIPT_DATA[@]}"; do
        IFS='|' read -r name description source <<< "$entry"
        if [[ "$source" == "global" ]]; then
            MENU_OPTIONS+=("$name" "$description")
        else
            MENU_OPTIONS+=("$name" "[local] $description")
        fi
    done

    # Show selection dialog
    TEMPFILE=$(mktemp)
    dialog --clear --title "Lab Utils" \
        --menu "Select utility to execute:" \
        20 120 12 \
        "${MENU_OPTIONS[@]}" \
        2>$TEMPFILE >/dev/tty || {
        clear
        rm -f $TEMPFILE
        exit 0
    }

    # save up response and clean up the screen
    CHOICE=$(cat $TEMPFILE)
    rm -f $TEMPFILE
    clear

    # Find and execute the selected script
    SCRIPT_PATH=$(find_script "$CHOICE")
    if [[ -n "$SCRIPT_PATH" ]]; then
        echo "Executing: ${SCRIPT_PATH}"
        "$SCRIPT_PATH"
    else
        echo "Error: Script '$CHOICE' not found"
        exit 1
    fi
}

# Main logic
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --list|-l)
        list_scripts
        ;;
    --create-local)
        create_local_scripts
        ;;
    "")
        run_interactive_menu
        ;;
    *)
        # Try to execute the specified script
        SCRIPT_PATH=$(find_script "$1") || {
            echo "Error: Script '$1' not found"
            echo ""
            echo "Use 'lab-utils --list' to see available scripts"
            exit 1
        }
        echo "Executing: ${SCRIPT_PATH}"
        shift
        "$SCRIPT_PATH" "$@"
        ;;
esac

# EOF
