#!/opt/conda/bin/python3
"""
Set an environment variable in ~/.profile.

Usage: set-profile-var VAR_NAME value

Example: set-profile-var JUPYTERLAB_TERMINAL_SHELL /bin/bash
"""

import re
import shutil
import sys
from pathlib import Path

PROFILE_FILE = Path.home() / ".profile"

# Colors
GREEN = '\033[0;32m'
ORANGE = '\033[0;33m'
NC = '\033[0m'


def set_profile_value(env_var: str, value: str) -> Path:
    """Set an environment variable in ~/.profile."""
    backup_path = Path(str(PROFILE_FILE) + ".backup")

    if PROFILE_FILE.exists():
        shutil.copy2(PROFILE_FILE, backup_path)
        content = PROFILE_FILE.read_text()
    else:
        PROFILE_FILE.touch()
        content = ""

    export_line = f'export {env_var}="{value}"'
    comment = f"# set {env_var.lower().replace('_', ' ')}"

    # Check if variable already exists
    pattern = rf'^\s*(?:export\s+)?{re.escape(env_var)}=.*$'
    if re.search(pattern, content, re.MULTILINE):
        content = re.sub(pattern, export_line, content, flags=re.MULTILINE)
    else:
        if content and not content.endswith("\n"):
            content += "\n"
        content += f"{comment}\n{export_line}\n"

    PROFILE_FILE.write_text(content)
    return backup_path


def main():
    if len(sys.argv) < 3:
        print("Usage: set-profile-var VAR_NAME value", file=sys.stderr)
        sys.exit(1)

    var_name = sys.argv[1]
    value = sys.argv[2]

    backup = set_profile_value(var_name, value)
    print(f"{GREEN}{var_name} set to: {value}{NC}")
    print(f"Backup: {backup}")

    # Special message for certain variables
    if var_name == "JUPYTERLAB_TERMINAL_SHELL":
        print(f"\n{ORANGE}Restart JupyterLab for changes to take effect.{NC}")


if __name__ == "__main__":
    main()
