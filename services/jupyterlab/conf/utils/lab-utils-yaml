#!/usr/bin/env python3
"""
YAML-driven Lab Utils Menu

Renders hierarchical menus from YAML configuration using dialog.
Supports submenus with back navigation and command execution.
"""

import os
import sys
import subprocess
import yaml
from pathlib import Path

# Configuration
SCRIPT_DIR = Path(__file__).parent.resolve()
MENU_CONFIG = SCRIPT_DIR / "lab-utils-menu.yml"
GLOBAL_SCRIPTS_DIR = SCRIPT_DIR / "lab-utils.d"
LOCAL_SCRIPTS_DIR = Path.home() / ".local" / "lab-utils.d"

# Dialog settings
DIALOG_BACKTITLE = "Stellars JupyterLab DS"


def load_menu_config(config_path: Path) -> dict:
    """Load menu configuration from YAML file."""
    if not config_path.exists():
        print(f"Error: Menu configuration not found: {config_path}", file=sys.stderr)
        sys.exit(1)

    with open(config_path) as f:
        return yaml.safe_load(f)


def resolve_script_path(command: str) -> Path:
    """Resolve script path from command, checking global then local directories."""
    # Check global scripts first
    global_path = GLOBAL_SCRIPTS_DIR / command
    if global_path.exists() and global_path.is_file():
        return global_path

    # Check local scripts
    local_path = LOCAL_SCRIPTS_DIR / command
    if local_path.exists() and local_path.is_file():
        return local_path

    return None


def run_dialog_menu(title: str, items: list, show_back: bool = False) -> str:
    """
    Display a dialog menu and return the selected item tag.
    Returns None if cancelled, "BACK" if back selected.
    """
    menu_items = []

    # Add back option if in submenu
    if show_back:
        menu_items.extend(["BACK", "<- Back"])

    # Add menu items
    for i, item in enumerate(items, 1):
        tag = str(i)
        name = item.get("name", f"Item {i}")
        # Add arrow indicator for submenus
        if "submenu" in item:
            name = f"{name} ->"
        menu_items.extend([tag, name])

    # Calculate menu height
    menu_height = min(len(items) + (1 if show_back else 0), 15)

    try:
        result = subprocess.run(
            [
                "dialog",
                "--backtitle", DIALOG_BACKTITLE,
                "--title", title,
                "--menu", "Select an option:",
                "20", "60", str(menu_height)
            ] + menu_items,
            capture_output=True,
            text=True
        )

        if result.returncode == 0:
            return result.stderr.strip()
        else:
            # User pressed Cancel or Escape
            return None

    except FileNotFoundError:
        print("Error: dialog utility not found", file=sys.stderr)
        sys.exit(1)


def execute_command(command: str, title: str):
    """Execute a script and wait for user acknowledgment."""
    script_path = resolve_script_path(command)

    if script_path is None:
        subprocess.run([
            "dialog",
            "--backtitle", DIALOG_BACKTITLE,
            "--title", "Error",
            "--msgbox", f"Script not found: {command}",
            "8", "50"
        ])
        return

    # Clear screen and run the script
    subprocess.run(["clear"])
    print(f"\n=== {title} ===\n")

    try:
        result = subprocess.run([str(script_path)], shell=False)
        exit_code = result.returncode
    except Exception as e:
        print(f"\nError executing script: {e}")
        exit_code = 1

    # Show completion message
    print(f"\n{'=' * 40}")
    if exit_code == 0:
        print("Script completed successfully.")
    else:
        print(f"Script exited with code: {exit_code}")

    input("\nPress Enter to continue...")


def navigate_menu(menu_config: dict, breadcrumb: list = None):
    """
    Navigate through menus recursively.
    breadcrumb tracks the current path for display.
    """
    if breadcrumb is None:
        breadcrumb = []

    title = menu_config.get("title", "Menu")
    items = menu_config.get("items", [])

    # Build title with breadcrumb
    if breadcrumb:
        display_title = " > ".join(breadcrumb + [title])
    else:
        display_title = title

    while True:
        selection = run_dialog_menu(display_title, items, show_back=bool(breadcrumb))

        if selection is None:
            # Cancelled - go back or exit
            return

        if selection == "BACK":
            return

        # Find selected item
        try:
            index = int(selection) - 1
            selected_item = items[index]
        except (ValueError, IndexError):
            continue

        item_name = selected_item.get("name", "")

        if "submenu" in selected_item:
            # Navigate into submenu
            submenu_config = {
                "title": item_name,
                "items": selected_item["submenu"]
            }
            navigate_menu(submenu_config, breadcrumb + [title])

        elif "command" in selected_item:
            # Execute command
            execute_command(selected_item["command"], item_name)


def main():
    """Main entry point."""
    # Load configuration
    config = load_menu_config(MENU_CONFIG)
    menu = config.get("menu", {})

    # Navigate menus
    navigate_menu(menu)

    # Clear screen on exit
    subprocess.run(["clear"])
    print("Lab Utils closed.")


if __name__ == "__main__":
    main()
